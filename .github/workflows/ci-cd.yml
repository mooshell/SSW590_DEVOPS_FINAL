name: Music Runner CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment Environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging
          - development

env:
  NODE_VERSION: '18'
  VERSION: '1.0.${{ github.run_number }}'
  BUILD_DATE: ${{ github.event.head_commit.timestamp }}

jobs:
  # ============================================
  # JOB 1: COMPILE LATEX WITH VERSION HISTORY
  # ============================================
  compile-latex:
    name: ðŸ“„ Compile LaTeX Documentation
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
      
      - name: ðŸ“ Generate Git Changelog
        run: |
          echo "=========================================="
          echo "ðŸ“ Generating changelog from git history"
          echo "=========================================="
          
          git log --pretty=format:"%h|%an|%ad|%s" --date=short -10 > /tmp/changelog.txt
          
          cat > /tmp/changelog.tex << 'CHANGELOG_EOF'
\section{Document Update History}

\subsection{Automated Version Tracking}
This document is automatically generated and updated with each CI/CD pipeline run.

\subsection{Recent Changes}

\begin{longtable}{|p{2cm}|p{2.5cm}|p{2cm}|p{6.5cm}|}
\hline
\textbf{Commit} & \textbf{Author} & \textbf{Date} & \textbf{Changes} \\
\hline
\endfirsthead
\hline
\textbf{Commit} & \textbf{Author} & \textbf{Date} & \textbf{Changes} \\
\hline
\endhead
\hline
\endlastfoot
CHANGELOG_EOF
          
          while IFS='|' read -r hash author date message; do
            message=$(echo "$message" | sed 's/_/\\_/g' | sed 's/#/\\#/g' | sed 's/&/\\&/g' | sed 's/%/\\%/g')
            author=$(echo "$author" | sed 's/_/\\_/g')
            echo "\\texttt{$hash} & $author & $date & $message \\\\\\" >> /tmp/changelog.tex
            echo "\\hline" >> /tmp/changelog.tex
          done < /tmp/changelog.txt
          
          echo "\\end{longtable}" >> /tmp/changelog.tex
          
          echo "âœ… Changelog generated"
          echo "=========================================="
      
      - name: ðŸ“ Generate LaTeX Document
        env:
          DOC_VERSION: ${{ env.VERSION }}
          DOC_BUILD: ${{ github.run_number }}
          DOC_COMMIT: ${{ github.sha }}
          DOC_BRANCH: ${{ github.ref_name }}
          DOC_ACTOR: ${{ github.actor }}
          DOC_EVENT: ${{ github.event_name }}
          DOC_REPO: ${{ github.repository }}
        run: |
          mkdir -p docs/latex
          CURRENT_DATE=$(date '+%Y-%m-%d')
          CURRENT_TIME=$(date '+%H:%M:%S')
          
          echo "Generating LaTeX document v${DOC_VERSION}..."
          
          cat > docs/latex/project-report.tex << LATEX_EOF
\\documentclass[12pt]{article}
\\usepackage[utf8]{inputenc}
\\usepackage[margin=1in]{geometry}
\\usepackage{hyperref}
\\usepackage{listings}
\\usepackage{longtable}
\\usepackage{fancyhdr}
\\usepackage{lastpage}

\\pagestyle{fancy}
\\fancyhead[L]{Music Runner DevOps Project}
\\fancyhead[R]{Version ${DOC_VERSION}}
\\fancyfoot[L]{Build #${DOC_BUILD}}
\\fancyfoot[C]{\\thepage\\ of \\pageref{LastPage}}
\\fancyfoot[R]{Generated: ${CURRENT_DATE}}

\\hypersetup{
    colorlinks=true,
    linkcolor=blue,
    urlcolor=cyan,
}

\\title{\\textbf{Music Runner Game}\\\\
\\Large CI/CD Pipeline Documentation\\\\
\\large Version ${DOC_VERSION}}

\\author{DevOps Engineering Team\\\\
Build #${DOC_BUILD}}

\\date{Generated: ${CURRENT_DATE} at ${CURRENT_TIME} UTC\\\\
Commit: \\texttt{${DOC_COMMIT}}\\\\
Branch: \\texttt{${DOC_BRANCH}}}

\\begin{document}

\\maketitle

\\begin{abstract}
This document provides comprehensive documentation for the Music Runner game project,
including CI/CD pipeline configuration, build process, and deployment instructions.
This document is automatically generated and updated with each build.
\\end{abstract}

\\tableofcontents
\\newpage

CHANGELOG_PLACEHOLDER

\\section{Current Build Information}

\\begin{table}[h]
\\centering
\\begin{tabular}{|l|l|}
\\hline
\\textbf{Property} & \\textbf{Value} \\\\
\\hline
Version & ${DOC_VERSION} \\\\
\\hline
Build Number & #${DOC_BUILD} \\\\
\\hline
Commit SHA & \\texttt{${DOC_COMMIT}} \\\\
\\hline
Branch & ${DOC_BRANCH} \\\\
\\hline
Build Date & ${CURRENT_DATE} \\\\
\\hline
Build Time & ${CURRENT_TIME} UTC \\\\
\\hline
Triggered By & ${DOC_ACTOR} \\\\
\\hline
Event Type & ${DOC_EVENT} \\\\
\\hline
\\end{tabular}
\\caption{Current Build Metadata}
\\end{table}

\\section{Technology Stack}

\\subsection{Frontend}
\\begin{itemize}
    \\item React 18.2.0 - UI framework
    \\item Tailwind CSS - Styling
    \\item Lucide React - Icons
\\end{itemize}

\\subsection{Backend}
\\begin{itemize}
    \\item Node.js 18 - Runtime
    \\item Express 4.18 - Web framework
    \\item PostgreSQL 15 - Database
    \\item Jest 29.7 - Testing
\\end{itemize}

\\section{CI/CD Pipeline}

The automated pipeline consists of:

\\begin{enumerate}
    \\item Documentation Compilation
    \\item Source Code Building
    \\item Automated Testing
    \\item Docker Image Packaging
    \\item Release Creation
\\end{enumerate}

\\section{Deployment}

\\subsection{Quick Deploy}
\\begin{verbatim}
# Download release
wget github.com/.../music-runner-VERSION.zip

# Extract and deploy
unzip music-runner-VERSION.zip
cd music-runner-VERSION
./scripts/deploy.sh
\\end{verbatim}

\\subsection{System Requirements}
\\begin{itemize}
    \\item Docker 20.10+
    \\item Docker Compose 2.0+
    \\item 2GB RAM
    \\item 5GB disk space
\\end{itemize}

\\section{API Reference}

\\subsection{Endpoints}
\\begin{itemize}
    \\item GET /api/health - Server status
    \\item GET /api/scores - Top 10 scores
    \\item POST /api/scores - Submit score
    \\item DELETE /api/scores - Clear scores
\\end{itemize}

\\section{Conclusion}

This project demonstrates enterprise DevOps practices including automated testing,
containerization, and continuous deployment. Build #${DOC_BUILD} completed successfully.

\\end{document}
LATEX_EOF
          
          sed -i '/CHANGELOG_PLACEHOLDER/r /tmp/changelog.tex' docs/latex/project-report.tex
          sed -i '/CHANGELOG_PLACEHOLDER/d' docs/latex/project-report.tex
          
          echo "âœ… LaTeX document generated"
      
      - name: ðŸ”¨ Compile LaTeX to PDF
        uses: xu-cheng/latex-action@v2
        with:
          root_file: project-report.tex
          working_directory: docs/latex
      
      - name: ðŸ“¤ Upload PDF
        uses: actions/upload-artifact@v4
        with:
          name: documentation
          path: docs/latex/project-report.pdf

  # ============================================
  # JOB 2: BUILD AND TEST
  # ============================================
  build-and-test:
    name: ðŸ—ï¸ Build and Test
    runs-on: ubuntu-latest
    needs: compile-latex
    
    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_DB: musicrunner_test
          POSTGRES_USER: testuser
          POSTGRES_PASSWORD: testpass
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
    
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v3
      
      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      - name: ðŸ“¦ Install Backend Dependencies
        working-directory: ./backend
        run: |
          echo "ðŸ“¦ Installing backend dependencies..."
          npm ci
          echo "âœ… Done"
      
      - name: ðŸ§ª Run Tests
        working-directory: ./backend
        env:
          DB_HOST: localhost
          DB_PORT: 5432
          DB_NAME: musicrunner_test
          DB_USER: testuser
          DB_PASSWORD: testpass
          NODE_ENV: test
        run: |
          echo "ðŸ§ª Running tests..."
          npm test -- --coverage
          echo "âœ… Tests passed"
      
      - name: ðŸ“¦ Install Frontend Dependencies
        working-directory: ./client
        run: npm ci
      
      - name: ðŸ—ï¸ Build Frontend
        working-directory: ./client
        env:
          CI: false
        run: |
          npm run build
          echo "âœ… Build complete"
      
      - name: ðŸ“¤ Upload Coverage
        uses: actions/upload-artifact@v4
        with:
          name: test-coverage
          path: backend/coverage/

  # ============================================
  # JOB 3: PACKAGE DOCKER
  # ============================================
  package-docker:
    name: ðŸ³ Package Docker Images
    runs-on: ubuntu-latest
    needs: build-and-test
    
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v3
      
      - name: ðŸ—ï¸ Build Images
        run: |
          echo "ðŸ³ Building Docker images..."
          docker build -t music-runner-backend:${{ env.VERSION }} ./backend
          docker build -t music-runner-client:${{ env.VERSION }} ./client
          echo "âœ… Images built"
      
      - name: ðŸ’¾ Save Images
        run: |
          echo "ðŸ’¾ Saving images..."
          mkdir -p docker-images
          docker save music-runner-backend:${{ env.VERSION }} | gzip > docker-images/backend-${{ env.VERSION }}.tar.gz
          docker save music-runner-client:${{ env.VERSION }} | gzip > docker-images/client-${{ env.VERSION }}.tar.gz
          ls -lh docker-images/
      
      - name: ðŸ“¤ Upload Images
        uses: actions/upload-artifact@v4
        with:
          name: docker-images
          path: docker-images/*.tar.gz

  # ============================================
  # JOB 4: CREATE RELEASE
  # ============================================
  create-release:
    name: ðŸ“¦ Create GitHub Release
    runs-on: ubuntu-latest
    needs: package-docker
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    permissions:
      contents: write
    
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v3
      
      - name: ðŸ“¥ Download Artifacts
        uses: actions/download-artifact@v4
      
      - name: ðŸ“¦ Create Package
        run: |
          echo "ðŸ“¦ Creating release package v${{ env.VERSION }}"
          
          mkdir -p music-runner-${{ env.VERSION }}/{docs,docker,source,tests,scripts}
          
          cp documentation/*.pdf music-runner-${{ env.VERSION }}/docs/ 2>/dev/null || true
          cp docker-images/*.tar.gz music-runner-${{ env.VERSION }}/docker/ 2>/dev/null || true
          cp -r test-coverage music-runner-${{ env.VERSION }}/tests/ 2>/dev/null || true
          cp -r backend music-runner-${{ env.VERSION }}/source/
          cp -r client music-runner-${{ env.VERSION }}/source/
          cp docker-compose.yml music-runner-${{ env.VERSION }}/ 2>/dev/null || true
          
          cat > music-runner-${{ env.VERSION }}/scripts/deploy.sh << 'DEPLOY_EOF'
#!/bin/bash
echo "ðŸš€ Deploying Music Runner"
docker load < docker/backend-*.tar.gz
docker load < docker/client-*.tar.gz
cd .. && docker-compose up -d
echo "âœ… Deployment complete!"
DEPLOY_EOF
          
          chmod +x music-runner-${{ env.VERSION }}/scripts/deploy.sh
          
          cat > music-runner-${{ env.VERSION }}/README.md << 'README_EOF'
# Music Runner - Deployment Package

## Quick Deploy
```bash
./scripts/deploy.sh
```

## Access
- Game: http://localhost:3000
- API: http://localhost:3001/api/health
README_EOF
          
          zip -r music-runner-${{ env.VERSION }}.zip music-runner-${{ env.VERSION }}/
          
          echo "âœ… Package created"
          ls -lh music-runner-${{ env.VERSION }}.zip
      
      - name: ðŸ“ Release Notes
        run: |
          cat > RELEASE_NOTES.md << EOF
## ðŸŽµ Music Runner v${{ env.VERSION }}

### Deployment Artifact v${{ env.VERSION }}

**Build Details:**
- Version: ${{ env.VERSION }}
- Build #: ${{ github.run_number }}
- Commit: \`${{ github.sha }}\`
- Build time: ${{ env.BUILD_DATE }}
- Tests Status: âœ… All passed

### This artifact contains the complete website ready for deployment.

---

## ðŸ“¦ Package Contents

- âœ… Complete source code
- âœ… Docker images
- âœ… PDF documentation with version history
- âœ… Test coverage reports
- âœ… Deployment scripts

## ðŸš€ Quick Deploy

\`\`\`bash
unzip music-runner-${{ env.VERSION }}.zip
cd music-runner-${{ env.VERSION }}
./scripts/deploy.sh
\`\`\`

## ðŸŽ® Access

- **Game**: http://localhost:3000
- **API**: http://localhost:3001/api/health

## ðŸ“‹ Requirements

- Docker 20.10+
- Docker Compose 2.0+
- 2GB RAM
- 5GB disk
EOF
      
      - name: ðŸ·ï¸ Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ env.VERSION }}
          name: Release ${{ env.VERSION }}
          body_path: RELEASE_NOTES.md
          draft: false
          prerelease: false
          files: |
            music-runner-${{ env.VERSION }}.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: ðŸŽ‰ Complete
        run: |
          echo "ðŸŽ‰ GitHub Release Created"
          echo "Version: v${{ env.VERSION }}"
          echo "View at: https://github.com/${{ github.repository }}/releases/tag/v${{ env.VERSION }}"

  # ============================================
  # JOB 5: SUMMARY
  # ============================================
  summary:
    name: ðŸ“‹ Pipeline Summary
    runs-on: ubuntu-latest
    needs: [compile-latex, build-and-test, package-docker, create-release]
    if: always()
    
    steps:
      - name: ðŸ“Š Display Summary
        run: |
          echo "=========================================="
          echo "ðŸŽµ MUSIC RUNNER CI/CD PIPELINE"
          echo "   BUILD SUMMARY"
          echo "=========================================="
          echo ""
          echo "Version: v${{ env.VERSION }}"
          echo "Build: #${{ github.run_number }}"
          echo ""
          echo "Job Results:"
          echo "------------"
          echo "ðŸ“„ Documentation:     ${{ needs.compile-latex.result }}"
          echo "ðŸ—ï¸ Build & Test:      ${{ needs.build-and-test.result }}"
          echo "ðŸ³ Docker Package:    ${{ needs.package-docker.result }}"
          echo "ðŸ“¦ GitHub Release:    ${{ needs.create-release.result }}"
          echo ""
          echo "=========================================="
          if [ "${{ needs.build-and-test.result }}" == "success" ]; then
            echo "âœ… PIPELINE SUCCESSFUL"
            echo "ðŸ“¦ Release: v${{ env.VERSION }}"
          else
            echo "âŒ PIPELINE FAILED"
          fi
          echo "=========================================="