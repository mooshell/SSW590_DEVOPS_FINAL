name: Music Runner CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment Environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging
          - development

env:
  NODE_VERSION: '18'
  VERSION: '1.0.${{ github.run_number }}'
  BUILD_DATE: ${{ github.event.head_commit.timestamp }}

jobs:
  compile-latex:
    name: ðŸ“„ Compile LaTeX Documentation
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: ðŸ“ Generate Git Changelog
        id: changelog
        run: |
          echo "Generating changelog from git history"
          git log --pretty=format:"%h|%an|%ad|%s" --date=short -10 > /tmp/changelog.txt
          
          # Create changelog LaTeX file
          {
            echo '\section{Document Update History}'
            echo ''
            echo '\subsection{Automated Version Tracking}'
            echo 'This document is automatically generated and updated with each CI/CD pipeline run.'
            echo ''
            echo '\subsection{Recent Changes}'
            echo ''
            echo '\begin{longtable}{|p{2cm}|p{2.5cm}|p{2cm}|p{6.5cm}|}'
            echo '\hline'
            echo '\textbf{Commit} \& \textbf{Author} \& \textbf{Date} \& \textbf{Changes} \\'
            echo '\hline'
            echo '\endfirsthead'
            echo '\hline'
            echo '\endlastfoot'
          } > /tmp/changelog.tex
          
          while IFS='|' read -r hash author date message; do
            message=$(echo "$message" | sed 's/_/\\_/g' | sed 's/#/\\#/g' | sed 's/&/\\\\&/g' | sed 's/%/\\%/g')
            author=$(echo "$author" | sed 's/_/\\_/g')
            echo "\\texttt{$hash} & $author & $date & $message \\\\" >> /tmp/changelog.tex
            echo "\\hline" >> /tmp/changelog.tex
          done < /tmp/changelog.txt
          
          echo '\end{longtable}' >> /tmp/changelog.tex
          echo "Changelog generated"

      - name: ðŸ“ Generate LaTeX Document
        env:
          DOC_VERSION: ${{ env.VERSION }}
          DOC_BUILD: ${{ github.run_number }}
          DOC_SHA: ${{ github.sha }}
          DOC_BRANCH: ${{ github.ref_name }}
          DOC_ACTOR: ${{ github.actor }}
          DOC_EVENT: ${{ github.event_name }}
          DOC_REPO: ${{ github.repository }}
        run: |
          mkdir -p docs/latex
          CURRENT_DATE=$(date '+%Y-%m-%d')
          CURRENT_TIME=$(date '+%H:%M:%S')
          
          cat > docs/latex/project-report.tex << 'LATEXEOF'
          \documentclass[12pt]{article}
          \usepackage[utf8]{inputenc}
          \usepackage[margin=1in]{geometry}
          \usepackage{hyperref}
          \usepackage{graphicx}
          \usepackage{listings}
          \usepackage{xcolor}
          \usepackage{longtable}
          \usepackage{booktabs}
          \usepackage{fancyhdr}
          \usepackage{lastpage}
          
          \definecolor{codegreen}{rgb}{0,0.6,0}
          \definecolor{codegray}{rgb}{0.5,0.5,0.5}
          \definecolor{codepurple}{rgb}{0.58,0,0.82}
          \definecolor{backcolour}{rgb}{0.95,0.95,0.92}
          
          \lstdefinestyle{mystyle}{
              backgroundcolor=\color{backcolour},
              commentstyle=\color{codegreen},
              keywordstyle=\color{magenta},
              numberstyle=\tiny\color{codegray},
              stringstyle=\color{codepurple},
              basicstyle=\ttfamily\footnotesize,
              breakatwhitespace=false,
              breaklines=true,
              captionpos=b,
              keepspaces=true,
              numbers=left,
              numbersep=5pt,
              showspaces=false,
              showstringspaces=false,
              showtabs=false,
              tabsize=2
          }
          \lstset{style=mystyle}
          
          \pagestyle{fancy}
          \fancyhead[L]{Music Runner DevOps Project}
          \fancyhead[R]{Version @@VERSION@@}
          \fancyfoot[L]{Build @@BUILD@@}
          \fancyfoot[C]{\thepage\ of \pageref{LastPage}}
          \fancyfoot[R]{Generated: @@DATE@@}
          
          \hypersetup{
              colorlinks=true,
              linkcolor=blue,
              filecolor=magenta,
              urlcolor=cyan,
          }
          
          \title{\textbf{Music Runner Game}\\
          \Large CI/CD Pipeline Documentation\\
          \large Version @@VERSION@@}
          
          \author{DevOps Engineering Team\\
          \texttt{@@REPO@@}\\
          Build @@BUILD@@}
          
          \date{Generated: @@DATE@@ at @@TIME@@ UTC\\
          Commit: \texttt{@@SHA@@}\\
          Branch: \texttt{@@BRANCH@@}}
          
          \begin{document}
          
          \maketitle
          
          \begin{abstract}
          This document provides comprehensive documentation for the Music Runner game project,
          including CI/CD pipeline configuration, build process, testing procedures, deployment
          instructions, and complete version history.
          \end{abstract}
          
          \tableofcontents
          \newpage
          
          @@CHANGELOG@@
          
          \newpage
          \section{Current Build Information}
          
          \subsection{Version Details}
          \begin{table}[h]
          \centering
          \begin{tabular}{|l|l|}
          \hline
          \textbf{Property} & \textbf{Value} \\
          \hline
          Version & @@VERSION@@ \\
          \hline
          Build Number & @@BUILD@@ \\
          \hline
          Commit SHA & \texttt{@@SHA@@} \\
          \hline
          Branch & @@BRANCH@@ \\
          \hline
          Build Date & @@DATE@@ \\
          \hline
          Build Time & @@TIME@@ UTC \\
          \hline
          Triggered By & @@ACTOR@@ \\
          \hline
          Event Type & @@EVENT@@ \\
          \hline
          \end{tabular}
          \caption{Current Build Metadata}
          \end{table}
          
          \section{Executive Summary}
          
          Music Runner is a web-based rhythm game that demonstrates modern DevOps practices
          and software engineering principles.
          
          \section{Technology Stack}
          
          \subsection{Frontend Technologies}
          \begin{itemize}
              \item React 18.2.0 - Component-based UI framework
              \item Tailwind CSS - Utility-first CSS framework
              \item Lucide React - Icon library
          \end{itemize}
          
          \subsection{Backend Technologies}
          \begin{itemize}
              \item Node.js 18 - JavaScript runtime
              \item Express 4.18.2 - Web framework
              \item PostgreSQL 15 - Database
              \item Jest 29.7.0 - Testing framework
          \end{itemize}
          
          \subsection{DevOps Infrastructure}
          \begin{itemize}
              \item Docker - Container platform
              \item Docker Compose - Orchestration
              \item GitHub Actions - CI/CD platform
              \item LaTeX - Documentation system
          \end{itemize}
          
          \section{CI/CD Pipeline}
          
          The pipeline consists of:
          \begin{enumerate}
              \item Documentation Compilation
              \item Build and Test
              \item Docker Packaging
              \item Release Creation
          \end{enumerate}
          
          \section{Deployment}
          
          \subsection{Prerequisites}
          \begin{itemize}
              \item Docker 20.10+
              \item Docker Compose 2.0+
              \item 2GB RAM
              \item 5GB disk space
          \end{itemize}
          
          \subsection{Quick Start}
          Download the release and run: \texttt{./scripts/deploy.sh}
          
          \subsection{Access Points}
          \begin{itemize}
              \item Game UI: http://localhost:3000
              \item API: http://localhost:3001/api/health
          \end{itemize}
          
          \section{API Reference}
          
          \begin{itemize}
              \item GET /api/health - Server status
              \item GET /api/scores - Top 10 scores
              \item POST /api/scores - Submit score
              \item DELETE /api/scores - Clear scores
          \end{itemize}
          
          \section{Conclusion}
          
          Build @@BUILD@@ completed successfully. Ready for deployment.
          
          \end{document}
          LATEXEOF
          
          # Remove leading spaces from heredoc content
          sed -i 's/^          //' docs/latex/project-report.tex
          
          # Replace placeholders
          sed -i "s|@@VERSION@@|${DOC_VERSION}|g" docs/latex/project-report.tex
          sed -i "s|@@BUILD@@|${DOC_BUILD}|g" docs/latex/project-report.tex
          sed -i "s|@@SHA@@|${DOC_SHA}|g" docs/latex/project-report.tex
          sed -i "s|@@BRANCH@@|${DOC_BRANCH}|g" docs/latex/project-report.tex
          sed -i "s|@@ACTOR@@|${DOC_ACTOR}|g" docs/latex/project-report.tex
          sed -i "s|@@EVENT@@|${DOC_EVENT}|g" docs/latex/project-report.tex
          sed -i "s|@@REPO@@|${DOC_REPO}|g" docs/latex/project-report.tex
          sed -i "s|@@DATE@@|${CURRENT_DATE}|g" docs/latex/project-report.tex
          sed -i "s|@@TIME@@|${CURRENT_TIME}|g" docs/latex/project-report.tex
          
          # Insert changelog
          sed -i '/@@CHANGELOG@@/r /tmp/changelog.tex' docs/latex/project-report.tex
          sed -i '/@@CHANGELOG@@/d' docs/latex/project-report.tex
          
          echo "LaTeX document generated"

      - name: ðŸ”¨ Compile LaTeX to PDF
        uses: xu-cheng/latex-action@v2
        with:
          root_file: project-report.tex
          working_directory: docs/latex

      - name: ðŸ“¤ Upload PDF Documentation
        uses: actions/upload-artifact@v4
        with:
          name: documentation
          path: docs/latex/project-report.pdf

  build-and-test:
    name: ðŸ—ï¸ Build and Test
    runs-on: ubuntu-latest
    needs: compile-latex

    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_DB: musicrunner_test
          POSTGRES_USER: testuser
          POSTGRES_PASSWORD: testpass
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v3

      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ðŸ“¦ Install Backend Dependencies
        working-directory: ./backend
        run: npm ci

      - name: ðŸ§ª Run Backend Tests
        working-directory: ./backend
        env:
          DB_HOST: localhost
          DB_PORT: 5432
          DB_NAME: musicrunner_test
          DB_USER: testuser
          DB_PASSWORD: testpass
          NODE_ENV: test
        run: npm test -- --coverage

      - name: ðŸ“¦ Install Frontend Dependencies
        working-directory: ./client
        run: npm ci

      - name: ðŸ—ï¸ Build Frontend
        working-directory: ./client
        env:
          CI: false
        run: npm run build

      - name: ðŸ“¤ Upload Test Results
        uses: actions/upload-artifact@v4
        with:
          name: test-coverage
          path: backend/coverage/

  package-docker:
    name: ðŸ³ Package Docker Images
    runs-on: ubuntu-latest
    needs: build-and-test

    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v3

      - name: ðŸ—ï¸ Build Docker Images
        run: |
          docker build -t music-runner-backend:${{ env.VERSION }} ./backend
          docker build -t music-runner-client:${{ env.VERSION }} ./client

      - name: ðŸ’¾ Save Docker Images
        run: |
          mkdir -p docker-images
          docker save music-runner-backend:${{ env.VERSION }} | gzip > docker-images/backend-${{ env.VERSION }}.tar.gz
          docker save music-runner-client:${{ env.VERSION }} | gzip > docker-images/client-${{ env.VERSION }}.tar.gz

      - name: ðŸ“¤ Upload Docker Images
        uses: actions/upload-artifact@v4
        with:
          name: docker-images
          path: docker-images/*.tar.gz

  create-release:
    name: ðŸ“¦ Create GitHub Release
    runs-on: ubuntu-latest
    needs: package-docker
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    permissions:
      contents: write

    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v3

      - name: ðŸ“¥ Download All Artifacts
        uses: actions/download-artifact@v4

      - name: ðŸ“¦ Create Release Package
        env:
          PKG_VERSION: ${{ env.VERSION }}
        run: |
          mkdir -p music-runner-${PKG_VERSION}/{docs,docker,source,tests,scripts}
          
          cp documentation/*.pdf music-runner-${PKG_VERSION}/docs/ 2>/dev/null || true
          cp docker-images/*.tar.gz music-runner-${PKG_VERSION}/docker/ 2>/dev/null || true
          cp -r test-coverage music-runner-${PKG_VERSION}/tests/ 2>/dev/null || true
          cp -r backend music-runner-${PKG_VERSION}/source/
          cp -r client music-runner-${PKG_VERSION}/source/
          cp docker-compose.yml music-runner-${PKG_VERSION}/ 2>/dev/null || true
          
          cat > music-runner-${PKG_VERSION}/scripts/deploy.sh << 'DEPLOYEOF'
          #!/bin/bash
          echo "Deploying Music Runner"
          VERSION=$(basename $(pwd) | sed 's/music-runner-//')
          docker load < docker/backend-${VERSION}.tar.gz
          docker load < docker/client-${VERSION}.tar.gz
          cd .. && docker-compose up -d
          echo "Deployment complete!"
          echo "Game: http://localhost:3000"
          echo "API: http://localhost:3001/api/health"
          DEPLOYEOF
          
          chmod +x music-runner-${PKG_VERSION}/scripts/deploy.sh
          
          zip -r music-runner-${PKG_VERSION}.zip music-runner-${PKG_VERSION}/

      - name: ðŸ“ Generate Release Notes
        env:
          PKG_VERSION: ${{ env.VERSION }}
          PKG_BUILD: ${{ github.run_number }}
          PKG_SHA: ${{ github.sha }}
        run: |
          cat > RELEASE_NOTES.md << NOTESEOF
          ## Music Runner v${PKG_VERSION}
          
          **Build Details:**
          - Version: ${PKG_VERSION}
          - Build: #${PKG_BUILD}
          - Commit: ${PKG_SHA}
          
          ## Package Contents
          - Complete source code
          - Docker images
          - PDF documentation
          - Test coverage reports
          - Deployment scripts
          
          ## Quick Deploy
          \`\`\`bash
          unzip music-runner-${PKG_VERSION}.zip
          cd music-runner-${PKG_VERSION}
          ./scripts/deploy.sh
          \`\`\`
          
          ## Access
          - Game: http://localhost:3000
          - API: http://localhost:3001/api/health
          NOTESEOF

      - name: ðŸ·ï¸ Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ env.VERSION }}
          name: Release ${{ env.VERSION }}
          body_path: RELEASE_NOTES.md
          draft: false
          prerelease: false
          files: |
            music-runner-${{ env.VERSION }}.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  summary:
    name: ðŸ“‹ Pipeline Summary
    runs-on: ubuntu-latest
    needs: [compile-latex, build-and-test, package-docker, create-release]
    if: always()

    steps:
      - name: ðŸ“Š Display Pipeline Summary
        run: |
          echo "=========================================="
          echo "MUSIC RUNNER CI/CD PIPELINE SUMMARY"
          echo "=========================================="
          echo "Version: v${{ env.VERSION }}"
          echo "Build: #${{ github.run_number }}"
          echo ""
          echo "Job Results:"
          echo "  Documentation: ${{ needs.compile-latex.result }}"
          echo "  Build/Test:    ${{ needs.build-and-test.result }}"
          echo "  Docker:        ${{ needs.package-docker.result }}"
          echo "  Release:       ${{ needs.create-release.result }}"
          echo "=========================================="