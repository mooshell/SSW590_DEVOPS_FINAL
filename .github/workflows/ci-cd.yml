name: Music Runner CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment Environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging
          - development

env:
  NODE_VERSION: '18'
  VERSION: '1.0.${{ github.run_number }}'
  BUILD_DATE: ${{ github.event.head_commit.timestamp }}

jobs:
  # ============================================
  # JOB 1: COMPILE LATEX DOCUMENTATION
  # ============================================
  compile-latex:
    name: ðŸ“„ Compile LaTeX Documentation
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v3
      
      - name: ðŸ“ Generate LaTeX Document
        run: |
          mkdir -p docs/latex
          cat > docs/latex/project-report.tex << 'LATEX_EOF'
          \documentclass{article}
          \usepackage[utf8]{inputenc}
          \usepackage{hyperref}
          
          \title{Music Runner - DevOps Project\\Version ${{ env.VERSION }}}
          \author{DevOps Team}
          \date{\today}
          
          \begin{document}
          \maketitle
          
          \section{Build Information}
          \begin{itemize}
              \item Version: ${{ env.VERSION }}
              \item Build: \#${{ github.run_number }}
              \item Commit: \texttt{${{ github.sha }}}
              \item Date: \today
          \end{itemize}
          
          \section{Project Overview}
          Music Runner is a web-based rhythm game with:
          \begin{itemize}
              \item React 18 frontend
              \item Node.js Express backend
              \item PostgreSQL database
              \item Docker containerization
          \end{itemize}
          
          \section{CI/CD Pipeline}
          Automated pipeline with:
          \begin{itemize}
              \item LaTeX documentation generation
              \item Source code compilation
              \item Automated testing
              \item Docker image packaging
              \item GitHub release creation
          \end{itemize}
          
          \end{document}
          LATEX_EOF
      
      - name: ðŸ”¨ Compile LaTeX to PDF
        uses: xu-cheng/latex-action@v2
        with:
          root_file: project-report.tex
          working_directory: docs/latex
      
      - name: ðŸ“¤ Upload PDF Artifact
        uses: actions/upload-artifact@v4
        with:
          name: documentation
          path: docs/latex/project-report.pdf

  # ============================================
  # JOB 2: BUILD AND TEST
  # ============================================
  build-and-test:
    name: ðŸ—ï¸ Build and Test
    runs-on: ubuntu-latest
    needs: compile-latex
    
    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_DB: musicrunner_test
          POSTGRES_USER: testuser
          POSTGRES_PASSWORD: testpass
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
    
    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v3
      
      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      - name: ðŸ“¦ Install Backend Dependencies
        working-directory: ./backend
        run: |
          echo "=========================================="
          echo "ðŸ“¦ Installing backend dependencies..."
          echo "=========================================="
          npm ci
          echo "âœ… Dependencies installed"
      
      - name: ðŸ§ª Run Tests
        working-directory: ./backend
        env:
          DB_HOST: localhost
          DB_PORT: 5432
          DB_NAME: musicrunner_test
          DB_USER: testuser
          DB_PASSWORD: testpass
          NODE_ENV: test
        run: |
          echo "=========================================="
          echo "ðŸ§ª Running automated tests..."
          echo "=========================================="
          npm test -- --coverage
          echo "âœ… All tests passed"
      
      - name: ðŸ“¦ Install Frontend Dependencies
        working-directory: ./client
        run: npm ci
      
      - name: ðŸ—ï¸ Build Frontend
        working-directory: ./client
        env:
          CI: false
        run: |
          echo "=========================================="
          echo "ðŸ—ï¸ Building production bundle..."
          echo "=========================================="
          npm run build
          echo "âœ… Build complete"
      
      - name: ðŸ“¤ Upload Test Results
        uses: actions/upload-artifact@v4
        with:
          name: test-coverage
          path: backend/coverage/

  # ============================================
  # JOB 3: PACKAGE DOCKER IMAGES
  # ============================================
  package-docker:
    name: ðŸ³ Package Docker Images
    runs-on: ubuntu-latest
    needs: build-and-test
    
    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v3
      
      - name: ðŸ—ï¸ Build Docker Images
        run: |
          echo "=========================================="
          echo "ðŸ³ Building Docker images..."
          echo "=========================================="
          docker build -t music-runner-backend:${{ env.VERSION }} ./backend
          docker build -t music-runner-client:${{ env.VERSION }} ./client
          echo "âœ… Images built successfully"
      
      - name: ðŸ’¾ Save Docker Images
        run: |
          echo "=========================================="
          echo "ðŸ’¾ Saving Docker images..."
          echo "=========================================="
          mkdir -p docker-images
          docker save music-runner-backend:${{ env.VERSION }} | gzip > docker-images/backend-${{ env.VERSION }}.tar.gz
          docker save music-runner-client:${{ env.VERSION }} | gzip > docker-images/client-${{ env.VERSION }}.tar.gz
          ls -lh docker-images/
          echo "âœ… Images saved"
      
      - name: ðŸ“¤ Upload Docker Images
        uses: actions/upload-artifact@v4
        with:
          name: docker-images
          path: docker-images/*.tar.gz

  # ============================================
  # JOB 4: CREATE RELEASE PACKAGE
  # ============================================
  create-release:
    name: ðŸ“¦ Create GitHub Release
    runs-on: ubuntu-latest
    needs: package-docker
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    permissions:
      contents: write
    
    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v3
      
      - name: ðŸ“¥ Download All Artifacts
        uses: actions/download-artifact@v4
      
      - name: ðŸ“¦ Create Release Package
        run: |
          echo "=========================================="
          echo "ðŸ“¦ Creating release package v${{ env.VERSION }}"
          echo "=========================================="
          
          # Create release directory structure
          mkdir -p music-runner-${{ env.VERSION }}/{docs,docker,source,tests,scripts}
          
          # Copy documentation
          cp documentation/*.pdf music-runner-${{ env.VERSION }}/docs/project-report.pdf 2>/dev/null || echo "No docs"
          
          # Copy Docker images
          cp docker-images/*.tar.gz music-runner-${{ env.VERSION }}/docker/ 2>/dev/null || echo "No images"
          
          # Copy test results
          cp -r test-coverage music-runner-${{ env.VERSION }}/tests/ 2>/dev/null || echo "No tests"
          
          # Copy source code
          cp -r backend music-runner-${{ env.VERSION }}/source/
          cp -r client music-runner-${{ env.VERSION }}/source/
          cp docker-compose.yml music-runner-${{ env.VERSION }}/ 2>/dev/null || true
          cp README.md music-runner-${{ env.VERSION }}/ 2>/dev/null || true
          
          # Create deployment script
          cat > music-runner-${{ env.VERSION }}/scripts/deploy.sh << 'DEPLOY_EOF'
          #!/bin/bash
          echo "ðŸš€ Deploying Music Runner v${{ env.VERSION }}"
          echo "Loading Docker images..."
          docker load < docker/backend-${{ env.VERSION }}.tar.gz
          docker load < docker/client-${{ env.VERSION }}.tar.gz
          echo "Starting services..."
          cd .. && docker-compose up -d
          echo "âœ… Deployment complete!"
          DEPLOY_EOF
          
          chmod +x music-runner-${{ env.VERSION }}/scripts/deploy.sh
          
          # Create README for the release
          cat > music-runner-${{ env.VERSION }}/README.md << 'README_EOF'
          # Music Runner - Release v${{ env.VERSION }}
          
          ## Quick Start
          
          ```bash
          # Extract the release
          unzip music-runner-${{ env.VERSION }}.zip
          cd music-runner-${{ env.VERSION }}
          
          # Deploy
          ./scripts/deploy.sh
          ```
          
          ## Build Details
          
          - **Version**: ${{ env.VERSION }}
          - **Build**: #${{ github.run_number }}
          - **Commit**: ${{ github.sha }}
          - **Date**: ${{ env.BUILD_DATE }}
          - **Tests Status**: âœ… All passed
          
          ## What's Included
          
          - ðŸ“„ Project documentation (PDF)
          - ðŸ³ Docker images (backend & frontend)
          - ðŸ“ Complete source code
          - ðŸ§ª Test coverage reports
          - ðŸ“œ Deployment scripts
          
          ## System Requirements
          
          - Docker 20.10+
          - Docker Compose 2.0+
          - 2GB RAM minimum
          - 5GB disk space
          
          ## Deployment
          
          Access the application at:
          - Game: http://165.22.38.90:3000/
          
          ## Support
          
          Repository: ${{ github.repository }}
          README_EOF
          
          # Create release info file
          cat > music-runner-${{ env.VERSION }}/RELEASE_INFO.txt << 'INFO_EOF'
          ================================================
          MUSIC RUNNER - DEPLOYMENT ARTIFACT v${{ env.VERSION }}
          ================================================
          
          Build Details:
          --------------
          Version: ${{ env.VERSION }}
          Build #: ${{ github.run_number }}
          Commit: ${{ github.sha }}
          Branch: ${{ github.ref_name }}
          Build time: ${{ env.BUILD_DATE }}
          Built by: ${{ github.actor }}
          
          Artifact: music-runner-${{ env.VERSION }}.zip
          
          Tests Status: âœ… All passed
          
          This artifact contains the complete website ready for deployment.
          
          Package Contents:
          -----------------
          ðŸ“„ docs/              - Project documentation
          ðŸ³ docker/            - Docker images (tar.gz)
          ðŸ“ source/            - Complete source code
          ðŸ§ª tests/             - Test results
          ðŸ“œ scripts/           - Deployment automation
          
          Quick Deploy:
          -------------
          ./scripts/deploy.sh
          
          ================================================
          INFO_EOF
          
          # Create the ZIP file
          zip -r music-runner-${{ env.VERSION }}.zip music-runner-${{ env.VERSION }}/
          
          echo ""
          echo "âœ… Release package created:"
          ls -lh music-runner-${{ env.VERSION }}.zip
          echo "=========================================="
      
      - name: ðŸ“ Generate Release Notes
        id: release_notes
        run: |
          cat > RELEASE_NOTES.md << 'NOTES_EOF'
          ## ðŸŽµ Music Runner v${{ env.VERSION }}
          
          ### Build Information
          - **Version**: ${{ env.VERSION }}
          - **Build Number**: #${{ github.run_number }}
          - **Commit**: `${{ github.sha }}`
          - **Build Date**: ${{ env.BUILD_DATE }}
          - **Built By**: @${{ github.actor }}
          
          ### âœ… Tests Status
          All automated tests passed successfully!
          
          ### ðŸ“¦ Deployment Artifact
          This release includes:
          - âœ… Complete source code
          - âœ… Docker images (backend & frontend)
          - âœ… Project documentation (PDF)
          - âœ… Test coverage reports
          - âœ… Automated deployment scripts
          
          ### ðŸš€ Quick Deploy
          ```bash
          # Download and extract
          unzip music-runner-${{ env.VERSION }}.zip
          cd music-runner-${{ env.VERSION }}
          
          # Deploy with Docker
          ./scripts/deploy.sh
          ```
          
          ### ðŸŽ® Access the Application
          - **Game**: http://165.22.38.90:3000/
          
          ### ðŸ“‹ System Requirements
          - Docker 20.10+
          - Docker Compose 2.0+
          - 2GB RAM
          - 5GB disk space
          
          ### Assets
          - `music-runner-${{ env.VERSION }}.zip` - Complete deployment package
          - `Source code (zip)` - Source code only
          - `Source code (tar.gz)` - Source code only
          NOTES_EOF
      
      - name: ðŸ·ï¸ Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ env.VERSION }}
          name: Release ${{ env.VERSION }}
          body_path: RELEASE_NOTES.md
          draft: false
          prerelease: false
          files: |
            music-runner-${{ env.VERSION }}.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: ðŸŽ‰ Release Complete
        run: |
          echo "=========================================="
          echo "ðŸŽ‰ GITHUB RELEASE CREATED"
          echo "=========================================="
          echo "Version: v${{ env.VERSION }}"
          echo "Tag: v${{ env.VERSION }}"
          echo "Package: music-runner-${{ env.VERSION }}.zip"
          echo ""
          echo "View at:"
          echo "https://github.com/${{ github.repository }}/releases/tag/v${{ env.VERSION }}"
          echo "=========================================="

  # ============================================
  # JOB 5: PIPELINE SUMMARY
  # ============================================
  summary:
    name: ðŸ“‹ Pipeline Summary
    runs-on: ubuntu-latest
    needs: [compile-latex, build-and-test, package-docker, create-release]
    if: always()
    
    steps:
      - name: ðŸ“Š Display Results
        run: |
          echo "=========================================="
          echo "ðŸŽµ MUSIC RUNNER CI/CD PIPELINE"
          echo "   BUILD SUMMARY"
          echo "=========================================="
          echo ""
          echo "Version: v${{ env.VERSION }}"
          echo "Build: #${{ github.run_number }}"
          echo "Commit: ${{ github.sha }}"
          echo "Branch: ${{ github.ref_name }}"
          echo ""
          echo "Job Results:"
          echo "------------"
          echo "ðŸ“„ Documentation:     ${{ needs.compile-latex.result }}"
          echo "ðŸ—ï¸ Build & Test:      ${{ needs.build-and-test.result }}"
          echo "ðŸ³ Docker Package:    ${{ needs.package-docker.result }}"
          echo "ðŸ“¦ GitHub Release:    ${{ needs.create-release.result }}"
          echo ""
          echo "=========================================="
          if [ "${{ needs.build-and-test.result }}" == "success" ]; then
            echo "âœ… PIPELINE SUCCESSFUL"
            echo "ðŸ“¦ Release created: v${{ env.VERSION }}"
          else
            echo "âŒ PIPELINE FAILED"
          fi
          echo "=========================================="