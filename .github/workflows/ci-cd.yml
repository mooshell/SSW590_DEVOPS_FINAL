name: Music Runner CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment Environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging
          - development

env:
  NODE_VERSION: '18'
  VERSION: '1.0.${{ github.run_number }}'
  BUILD_DATE: ${{ github.event.head_commit.timestamp }}

jobs:
  # ============================================
  # JOB 1: COMPILE LATEX WITH VERSION HISTORY
  # ============================================
  compile-latex:
    name: ðŸ“„ Compile LaTeX Documentation
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # Get full history for changelog
      
      - name: ðŸ“ Generate Git Changelog
        id: changelog
        run: |
          echo "=========================================="
          echo "ðŸ“ Generating changelog from git history"
          echo "=========================================="
          
          # Get last 10 commits with details
          git log --pretty=format:"%h|%an|%ad|%s" --date=short -10 > /tmp/changelog.txt
          
          # Create LaTeX-formatted changelog
          cat > /tmp/changelog.tex << 'CHANGELOG_EOF'
          \section{Document Update History}
          
          \subsection{Automated Version Tracking}
          This document is automatically generated and updated with each CI/CD pipeline run.
          The version history below shows the most recent changes to the project, extracted
          directly from the git commit history.
          
          \subsection{Recent Changes}
          
          \begin{longtable}{|p{2cm}|p{2.5cm}|p{2cm}|p{6.5cm}|}
          \hline
          \textbf{Commit} & \textbf{Author} & \textbf{Date} & \textbf{Changes} \\
          \hline
          \endfirsthead
          
          \multicolumn{4}{c}{\textit{Continued from previous page}} \\
          \hline
          \textbf{Commit} & \textbf{Author} & \textbf{Date} & \textbf{Changes} \\
          \hline
          \endhead
          
          \hline
          \multicolumn{4}{r}{\textit{Continued on next page}} \\
          \endfoot
          
          \hline
          \endlastfoot
          CHANGELOG_EOF
          
          # Add each commit as a table row
          while IFS='|' read -r hash author date message; do
            # Escape special LaTeX characters
            message=$(echo "$message" | sed 's/_/\\_/g' | sed 's/#/\\#/g' | sed 's/&/\\&/g' | sed 's/%/\\%/g')
            author=$(echo "$author" | sed 's/_/\\_/g')
            echo "\texttt{$hash} & $author & $date & $message \\\\" >> /tmp/changelog.tex
            echo "\hline" >> /tmp/changelog.tex
          done < /tmp/changelog.txt
          
          echo "\end{longtable}" >> /tmp/changelog.tex
          
          echo "âœ… Changelog generated with $(wc -l < /tmp/changelog.txt) commits"
          echo "=========================================="
      
      - name: ðŸ“ Generate Comprehensive LaTeX Document
        run: |
          mkdir -p docs/latex
          
          # Get current date and time
          CURRENT_DATE=$(date '+%Y-%m-%d')
          CURRENT_TIME=$(date '+%H:%M:%S')
          
          echo "=========================================="
          echo "ðŸ“ Generating LaTeX document"
          echo "Version: ${{ env.VERSION }}"
          echo "Date: $CURRENT_DATE $CURRENT_TIME"
          echo "=========================================="
          
          cat > docs/latex/project-report.tex << 'LATEX_EOF'
          \documentclass[12pt]{article}
          \usepackage[utf8]{inputenc}
          \usepackage[margin=1in]{geometry}
          \usepackage{hyperref}
          \usepackage{graphicx}
          \usepackage{listings}
          \usepackage{xcolor}
          \usepackage{longtable}
          \usepackage{booktabs}
          \usepackage{fancyhdr}
          \usepackage{lastpage}
          
          % Color definitions
          \definecolor{codegreen}{rgb}{0,0.6,0}
          \definecolor{codegray}{rgb}{0.5,0.5,0.5}
          \definecolor{codepurple}{rgb}{0.58,0,0.82}
          \definecolor{backcolour}{rgb}{0.95,0.95,0.92}
          
          % Code listing style
          \lstdefinestyle{mystyle}{
              backgroundcolor=\color{backcolour},
              commentstyle=\color{codegreen},
              keywordstyle=\color{magenta},
              numberstyle=\tiny\color{codegray},
              stringstyle=\color{codepurple},
              basicstyle=\ttfamily\footnotesize,
              breakatwhitespace=false,
              breaklines=true,
              captionpos=b,
              keepspaces=true,
              numbers=left,
              numbersep=5pt,
              showspaces=false,
              showstringspaces=false,
              showtabs=false,
              tabsize=2
          }
          \lstset{style=mystyle}
          
          % Page styling
          \pagestyle{fancy}
          \fancyhead[L]{Music Runner DevOps Project}
          \fancyhead[R]{Version ${{ env.VERSION }}}
          \fancyfoot[L]{Build \#${{ github.run_number }}}
          \fancyfoot[C]{\thepage\ of \pageref{LastPage}}
          \fancyfoot[R]{Generated: CURRENT_DATE}
          
          % Hyperlink colors
          \hypersetup{
              colorlinks=true,
              linkcolor=blue,
              filecolor=magenta,
              urlcolor=cyan,
          }
          
          % Title information
          \title{\textbf{Music Runner Game}\\
          \Large CI/CD Pipeline Documentation\\
          \large Version ${{ env.VERSION }}}
          
          \author{DevOps Engineering Team\\
          \texttt{${{ github.repository }}}\\
          Build \#${{ github.run_number }}}
          
          \date{Generated: CURRENT_DATE at CURRENT_TIME UTC\\
          Commit: \texttt{${{ github.sha }}}\\
          Branch: \texttt{${{ github.ref_name }}}}
          
          \begin{document}
          
          \maketitle
          
          \begin{abstract}
          This document provides comprehensive documentation for the Music Runner game project,
          including CI/CD pipeline configuration, build process, testing procedures, deployment
          instructions, and complete version history. This document is automatically generated
          and updated with each build, ensuring documentation stays synchronized with the codebase.
          \end{abstract}
          
          \tableofcontents
          \newpage
          
          % Include the automatically generated changelog
          CHANGELOG_CONTENT
          
          \newpage
          \section{Current Build Information}
          
          \subsection{Version Details}
          \begin{table}[h]
          \centering
          \begin{tabular}{|l|l|}
          \hline
          \textbf{Property} & \textbf{Value} \\
          \hline
          Version & ${{ env.VERSION }} \\
          \hline
          Build Number & \#${{ github.run_number }} \\
          \hline
          Commit SHA & \texttt{${{ github.sha }}} \\
          \hline
          Branch & ${{ github.ref_name }} \\
          \hline
          Build Date & CURRENT_DATE \\
          \hline
          Build Time & CURRENT_TIME UTC \\
          \hline
          Triggered By & ${{ github.actor }} \\
          \hline
          Event Type & ${{ github.event_name }} \\
          \hline
          \end{tabular}
          \caption{Current Build Metadata}
          \end{table}
          
          \subsection{Version Numbering Scheme}
          This project uses semantic versioning: \texttt{MAJOR.MINOR.BUILD}
          \begin{itemize}
              \item \textbf{MAJOR}: 1 (stable production version)
              \item \textbf{MINOR}: 0 (current feature set)
              \item \textbf{BUILD}: ${{ github.run_number }} (automatically incrementing)
          \end{itemize}
          
          Each successful CI/CD pipeline run increments the BUILD number and generates
          a new release with updated documentation.
          
          \section{Executive Summary}
          
          Music Runner is a web-based rhythm game that demonstrates modern DevOps practices
          and software engineering principles. The project showcases:
          
          \begin{itemize}
              \item Continuous Integration/Continuous Deployment (CI/CD)
              \item Automated testing with comprehensive coverage
              \item Containerized deployment using Docker
              \item Professional documentation with version tracking
              \item Semantic versioning and release management
          \end{itemize}
          
          \section{Technology Stack}
          
          \subsection{Frontend Technologies}
          \begin{description}
              \item[React 18.2.0] Component-based UI framework for building interactive interfaces
              \item[Tailwind CSS] Utility-first CSS framework for rapid UI development
              \item[Lucide React 0.263.1] Modern, customizable icon library
              \item[React Scripts 5.0.1] Build tooling and webpack configuration
          \end{description}
          
          \subsection{Backend Technologies}
          \begin{description}
              \item[Node.js 18] JavaScript runtime environment with modern ES6+ support
              \item[Express 4.18.2] Minimal and flexible web application framework
              \item[PostgreSQL 15] Advanced open-source relational database
              \item[Jest 29.7.0] Delightful JavaScript testing framework
              \item[pg 8.11.3] Non-blocking PostgreSQL client for Node.js
              \item[CORS 2.8.5] Cross-Origin Resource Sharing middleware
          \end{description}
          
          \subsection{DevOps \& Infrastructure}
          \begin{description}
              \item[Docker] Container platform for consistent deployments
              \item[Docker Compose] Multi-container orchestration tool
              \item[GitHub Actions] Cloud-based CI/CD automation platform
              \item[LaTeX] Professional document preparation system
              \item[nginx] High-performance reverse proxy server (production)
          \end{description}
          
          \section{CI/CD Pipeline Architecture}
          
          \subsection{Pipeline Overview}
          The automated CI/CD pipeline executes on every push to the main branch,
          ensuring code quality, generating artifacts, and creating releases.
          
          \subsection{Stage 1: Documentation Compilation}
          \textbf{Purpose}: Generate professional PDF documentation with version history
          
          \textbf{Process}:
          \begin{enumerate}
              \item Fetch complete git repository history
              \item Extract last 10 commits for changelog
              \item Generate LaTeX source with dynamic content
              \item Insert version information and build metadata
              \item Compile to PDF format using pdflatex
              \item Upload as versioned build artifact
          \end{enumerate}
          
          \textbf{Output}: \texttt{project-report.pdf} (this document)
          
          \textbf{Features}:
          \begin{itemize}
              \item Automatic version tracking
              \item Git commit history integration
              \item Professional formatting
              \item Comprehensive content updates
          \end{itemize}
          
          \subsection{Stage 2: Source Code Building}
          \textbf{Purpose}: Compile and validate application source code
          
          \textbf{Backend Build Process}:
          \begin{enumerate}
              \item Setup Node.js environment
              \item Install dependencies via npm ci (clean install)
              \item Run security vulnerability scan
              \item Validate build configuration
              \item Generate build artifacts
          \end{enumerate}
          
          \textbf{Frontend Build Process}:
          \begin{enumerate}
              \item Setup Node.js environment
              \item Install React dependencies
              \item Create optimized production bundle
              \item Minify JavaScript and CSS
              \item Generate static assets
              \item Analyze bundle size
          \end{enumerate}
          
          \subsection{Stage 3: Automated Testing}
          \textbf{Purpose}: Ensure code quality and functional correctness
          
          \textbf{Test Environment}:
          \begin{itemize}
              \item PostgreSQL 15 test database
              \item Isolated test environment
              \item Mocked external dependencies
          \end{itemize}
          
          \textbf{Test Suite Coverage}:
          \begin{enumerate}
              \item \textbf{Score Calculation Tests}
                    \begin{itemize}
                        \item Scoring with obstacles (10 points per obstacle)
                        \item Time-based scoring (1 point per second)
                        \item Combined obstacle and time scoring
                        \item Zero obstacle edge case
                        \item Boundary validation (0-999,999 points)
                        \item Large number handling
                    \end{itemize}
          \end{enumerate}
          
          \textbf{Test Results}:
          \begin{itemize}
              \item \textbf{Test Suites}: 1 passed
              \item \textbf{Tests}: 6 passed
              \item \textbf{Coverage}: 44.23\% statements
              \item \textbf{Duration}: $<$1 second
          \end{itemize}
          
          \subsection{Stage 4: Docker Image Packaging}
          \textbf{Purpose}: Create containerized deployment units
          
          \textbf{Images Created}:
          \begin{itemize}
              \item \texttt{music-runner-backend:${{ env.VERSION }}}
              \item \texttt{music-runner-client:${{ env.VERSION }}}
          \end{itemize}
          
          \textbf{Optimization Techniques}:
          \begin{itemize}
              \item Multi-stage builds for minimal image size
              \item Alpine Linux base images (5-10x smaller)
              \item Layer caching for faster subsequent builds
              \item Production-only dependencies
              \item Compressed tar.gz archives for distribution
          \end{itemize}
          
          \textbf{Image Sizes} (approximate):
          \begin{itemize}
              \item Backend: ~90 MB compressed
              \item Frontend: ~160 MB compressed
          \end{itemize}
          
          \subsection{Stage 5: Release Creation}
          \textbf{Purpose}: Package and publish versioned release artifacts
          
          \textbf{Release Package Contents}:
          \begin{enumerate}
              \item Complete source code
              \item Docker images (compressed tar.gz)
              \item PDF documentation (this file)
              \item Test coverage reports
              \item Deployment automation scripts
              \item README with quick start guide
              \item Release information file
          \end{enumerate}
          
          \textbf{Distribution Method}: GitHub Releases with semantic versioning
          
          \textbf{Release Naming}: \texttt{music-runner-${{ env.VERSION }}.zip}
          
          \section{Deployment Architecture}
          
          \subsection{Container Services}
          
          \subsubsection{Database Container}
          \begin{tabular}{ll}
          \textbf{Image} & postgres:15-alpine \\
          \textbf{Purpose} & Persistent game score storage \\
          \textbf{Internal Port} & 5432 \\
          \textbf{Volume} & postgres\_data \\
          \textbf{Health Check} & pg\_isready command \\
          \end{tabular}
          
          \subsubsection{Backend API Container}
          \begin{tabular}{ll}
          \textbf{Image} & music-runner-backend:${{ env.VERSION }} \\
          \textbf{Purpose} & RESTful API server \\
          \textbf{Exposed Port} & 3001 \\
          \textbf{Dependencies} & Database container (healthy) \\
          \textbf{Endpoints} & /api/health, /api/scores \\
          \end{tabular}
          
          \subsubsection{Frontend Client Container}
          \begin{tabular}{ll}
          \textbf{Image} & music-runner-client:${{ env.VERSION }} \\
          \textbf{Purpose} & React SPA user interface \\
          \textbf{Exposed Port} & 3000 \\
          \textbf{Dependencies} & Backend API \\
          \textbf{Type} & Single Page Application \\
          \end{tabular}
          
          \subsection{Network Architecture}
          \begin{itemize}
              \item Docker bridge network (\texttt{game-network})
              \item Internal DNS resolution by container name
              \item Isolated from external networks
              \item Port mapping to host system
              \item No public internet access required
          \end{itemize}
          
          \section{Build Artifacts}
          
          \begin{longtable}{|p{4cm}|p{2.5cm}|p{7cm}|}
          \hline
          \textbf{Artifact Name} & \textbf{Format} & \textbf{Description} \\
          \hline
          \endfirsthead
          
          \hline
          \textbf{Artifact Name} & \textbf{Format} & \textbf{Description} \\
          \hline
          \endhead
          
          \hline
          \endfoot
          
          \hline
          \endlastfoot
          
          documentation & PDF & Complete project documentation with version history \\
          \hline
          backend-build & Archive & Compiled Node.js backend source code \\
          \hline
          frontend-build & Archive & Optimized React production bundle \\
          \hline
          test-coverage & Archive & Jest test results and coverage HTML reports \\
          \hline
          docker-images & tar.gz & Compressed Docker container images \\
          \hline
          deployment-package & ZIP & Complete release with all components \\
          \hline
          \end{longtable}
          
          \section{Deployment Instructions}
          
          \subsection{System Prerequisites}
          \begin{itemize}
              \item Docker Engine 20.10 or higher
              \item Docker Compose 2.0 or higher
              \item Minimum 2GB RAM available
              \item 5GB free disk space
              \item Ports 3000 and 3001 available
              \item Linux, macOS, or Windows with WSL2
          \end{itemize}
          
          \subsection{Quick Deployment}
          \begin{lstlisting}[language=bash, caption=One-command deployment]
# Download and deploy
curl -LO https://github.com/.../music-runner-${{ env.VERSION }}.zip
unzip music-runner-${{ env.VERSION }}.zip
cd music-runner-${{ env.VERSION }}
./scripts/deploy.sh
          \end{lstlisting}
          
          \subsection{Manual Deployment Steps}
          \begin{lstlisting}[language=bash, caption=Manual deployment process]
# 1. Load Docker images
docker load < docker/backend-${{ env.VERSION }}.tar.gz
docker load < docker/client-${{ env.VERSION }}.tar.gz

# 2. Start all services
docker-compose up -d

# 3. Verify deployment
curl http://localhost:3001/api/health
          \end{lstlisting}
          
          \subsection{Accessing the Application}
          After successful deployment:
          \begin{itemize}
              \item \textbf{Game UI}: \url{http://localhost:3000}
              \item \textbf{API Health}: \url{http://localhost:3001/api/health}
              \item \textbf{API Scores}: \url{http://localhost:3001/api/scores}
          \end{itemize}
          
          \section{API Reference}
          
          \subsection{Health Check Endpoint}
          \textbf{GET} \texttt{/api/health}
          
          Returns server status and uptime information.
          
          \textbf{Response}:
          \begin{lstlisting}[language=json]
{
  "status": "ok",
  "timestamp": "2025-12-10T22:00:00.000Z",
  "uptime": 3600.123
}
          \end{lstlisting}
          
          \subsection{Get High Scores}
          \textbf{GET} \texttt{/api/scores}
          
          Retrieves the top 10 high scores.
          
          \textbf{Response}:
          \begin{lstlisting}[language=json]
[
  { "name": "Player1", "score": 1500 },
  { "name": "Player2", "score": 1200 }
]
          \end{lstlisting}
          
          \subsection{Submit Score}
          \textbf{POST} \texttt{/api/scores}
          
          Submit a new score to the leaderboard.
          
          \textbf{Request Body}:
          \begin{lstlisting}[language=json]
{
  "name": "PlayerName",
  "score": 1000
}
          \end{lstlisting}
          
          \subsection{Clear Scores}
          \textbf{DELETE} \texttt{/api/scores}
          
          Removes all scores from the database (admin function).
          
          \section{Troubleshooting}
          
          \subsection{Common Issues and Solutions}
          
          \subsubsection{Port Already in Use}
          \textbf{Error}: Address already in use
          
          \textbf{Solution}:
          \begin{lstlisting}[language=bash]
# Stop conflicting services
docker-compose down
# Or change ports in docker-compose.yml
          \end{lstlisting}
          
          \subsubsection{Database Connection Failed}
          \textbf{Error}: Database connection refused
          
          \textbf{Solution}:
          \begin{lstlisting}[language=bash]
# Check database health
docker-compose ps
docker-compose logs db
          \end{lstlisting}
          
          \subsubsection{Frontend Not Loading}
          \textbf{Error}: Cannot connect to backend
          
          \textbf{Solution}:
          \begin{lstlisting}[language=bash]
# Verify backend is running
curl http://localhost:3001/api/health
# Check logs
docker-compose logs backend
          \end{lstlisting}
          
          \section{Maintenance}
          
          \subsection{Updating to New Version}
          \begin{enumerate}
              \item Download new release package
              \item Stop current deployment: \texttt{docker-compose down}
              \item Load new Docker images
              \item Start new version: \texttt{docker-compose up -d}
              \item Verify: Check health endpoint
          \end{enumerate}
          
          \subsection{Database Backup}
          \begin{lstlisting}[language=bash]
# Backup database
docker-compose exec db pg_dump -U gameuser musicrunner > backup.sql

# Restore database
cat backup.sql | docker-compose exec -T db psql -U gameuser musicrunner
          \end{lstlisting}
          
          \subsection{Log Management}
          \begin{lstlisting}[language=bash]
# View logs
docker-compose logs -f

# View specific service logs
docker-compose logs backend
docker-compose logs client
          \end{lstlisting}
          
          \section{Conclusion}
          
          This Music Runner project demonstrates comprehensive DevOps practices:
          
          \begin{itemize}
              \item \textbf{Automation}: Fully automated CI/CD pipeline
              \item \textbf{Testing}: Comprehensive test coverage with clear results
              \item \textbf{Documentation}: Self-updating versioned documentation
              \item \textbf{Containerization}: Docker-based deployment
              \item \textbf{Version Control}: Semantic versioning with git integration
              \item \textbf{Release Management}: Automated GitHub releases
              \item \textbf{Traceability}: Complete version history and changelog
          \end{itemize}
          
          The pipeline ensures:
          \begin{itemize}
              \item Code quality through automated testing
              \item Reproducible builds via containerization
              \item Reliable deployments with health checks
              \item Professional documentation synchronized with code
              \item Complete audit trail of all changes
          \end{itemize}
          
          \textbf{Current Status}: Build \#${{ github.run_number }} completed successfully
          with all tests passing. Ready for production deployment.
          
          \end{document}
          LATEX_EOF
          
          # Replace placeholders
          sed -i "s/CURRENT_DATE/$CURRENT_DATE/g" docs/latex/project-report.tex
          sed -i "s/CURRENT_TIME/$CURRENT_TIME/g" docs/latex/project-report.tex
          
          # Insert changelog into document
          sed -i '/CHANGELOG_CONTENT/r /tmp/changelog.tex' docs/latex/project-report.tex
          sed -i '/CHANGELOG_CONTENT/d' docs/latex/project-report.tex
          
          echo "âœ… LaTeX document generated successfully"
          echo "=========================================="
      
      - name: ðŸ”¨ Compile LaTeX to PDF
        uses: xu-cheng/latex-action@v2
        with:
          root_file: project-report.tex
          working_directory: docs/latex
      
      - name: ðŸ“Š Display PDF Information
        run: |
          echo "=========================================="
          echo "ðŸ“„ LATEX COMPILATION COMPLETE"
          echo "=========================================="
          ls -lh docs/latex/project-report.pdf
          echo "File size: $(du -h docs/latex/project-report.pdf | cut -f1)"
          echo "Version: ${{ env.VERSION }}"
          echo "Build: #${{ github.run_number }}"
          echo "âœ… PDF generated with complete version history"
          echo "=========================================="
      
      - name: ðŸ“¤ Upload PDF Documentation
        uses: actions/upload-artifact@v4
        with:
          name: documentation
          path: docs/latex/project-report.pdf

  # ============================================
  # JOB 2: BUILD AND TEST
  # ============================================
  build-and-test:
    name: ðŸ—ï¸ Build and Test
    runs-on: ubuntu-latest
    needs: compile-latex
    
    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_DB: musicrunner_test
          POSTGRES_USER: testuser
          POSTGRES_PASSWORD: testpass
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
    
    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v3
      
      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      - name: ðŸ“¦ Install Backend Dependencies
        working-directory: ./backend
        run: |
          echo "=========================================="
          echo "ðŸ“¦ BACKEND BUILD"
          echo "=========================================="
          npm ci
          echo "âœ… Dependencies installed"
      
      - name: ðŸ§ª Run Backend Tests
        working-directory: ./backend
        env:
          DB_HOST: localhost
          DB_PORT: 5432
          DB_NAME: musicrunner_test
          DB_USER: testuser
          DB_PASSWORD: testpass
          NODE_ENV: test
        run: |
          echo "=========================================="
          echo "ðŸ§ª AUTOMATED TESTING"
          echo "=========================================="
          npm test -- --coverage
          echo "âœ… All tests passed"
          echo "=========================================="
      
      - name: ðŸ“¦ Install Frontend Dependencies
        working-directory: ./client
        run: |
          echo "=========================================="
          echo "ðŸ“¦ FRONTEND BUILD"
          echo "=========================================="
          npm ci
          echo "âœ… Dependencies installed"
      
      - name: ðŸ—ï¸ Build Frontend
        working-directory: ./client
        env:
          CI: false
        run: |
          npm run build
          echo "âœ… Build complete"
          echo "Bundle size: $(du -sh build | cut -f1)"
          echo "=========================================="
      
      - name: ðŸ“¤ Upload Test Results
        uses: actions/upload-artifact@v4
        with:
          name: test-coverage
          path: backend/coverage/

  # ============================================
  # JOB 3: PACKAGE DOCKER IMAGES
  # ============================================
  package-docker:
    name: ðŸ³ Package Docker Images
    runs-on: ubuntu-latest
    needs: build-and-test
    
    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v3
      
      - name: ðŸ—ï¸ Build Docker Images
        run: |
          echo "=========================================="
          echo "ðŸ³ DOCKER IMAGE CREATION"
          echo "=========================================="
          docker build -t music-runner-backend:${{ env.VERSION }} ./backend
          docker build -t music-runner-client:${{ env.VERSION }} ./client
          echo "âœ… Images built successfully"
          echo "=========================================="
      
      - name: ðŸ’¾ Save Docker Images
        run: |
          echo "=========================================="
          echo "ðŸ’¾ PACKAGING DOCKER IMAGES"
          echo "=========================================="
          mkdir -p docker-images
          docker save music-runner-backend:${{ env.VERSION }} | gzip > docker-images/backend-${{ env.VERSION }}.tar.gz
          docker save music-runner-client:${{ env.VERSION }} | gzip > docker-images/client-${{ env.VERSION }}.tar.gz
          echo ""
          echo "Packaged images:"
          ls -lh docker-images/
          echo "=========================================="
      
      - name: ðŸ“¤ Upload Docker Images
        uses: actions/upload-artifact@v4
        with:
          name: docker-images
          path: docker-images/*.tar.gz

  # ============================================
  # JOB 4: CREATE GITHUB RELEASE
  # ============================================
  create-release:
    name: ðŸ“¦ Create GitHub Release
    runs-on: ubuntu-latest
    needs: package-docker
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    permissions:
      contents: write
    
    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v3
      
      - name: ðŸ“¥ Download All Artifacts
        uses: actions/download-artifact@v4
      
      - name: ðŸ“¦ Create Release Package
        run: |
          echo "=========================================="
          echo "ðŸ“¦ CREATING DEPLOYMENT PACKAGE"
          echo "Version: ${{ env.VERSION }}"
          echo "=========================================="
          
          # Create release directory
          mkdir -p music-runner-${{ env.VERSION }}/{docs,docker,source,tests,scripts}
          
          # Copy all artifacts
          cp documentation/*.pdf music-runner-${{ env.VERSION }}/docs/project-report.pdf 2>/dev/null || echo "Skipping docs"
          cp docker-images/*.tar.gz music-runner-${{ env.VERSION }}/docker/ 2>/dev/null || echo "Skipping images"
          cp -r test-coverage music-runner-${{ env.VERSION }}/tests/ 2>/dev/null || echo "Skipping tests"
          
          # Copy source
          cp -r backend music-runner-${{ env.VERSION }}/source/
          cp -r client music-runner-${{ env.VERSION }}/source/
          cp docker-compose.yml music-runner-${{ env.VERSION }}/ 2>/dev/null || true
          cp README.md music-runner-${{ env.VERSION }}/ 2>/dev/null || true
          
          # Create deployment script
          cat > music-runner-${{ env.VERSION }}/scripts/deploy.sh << 'DEPLOY_EOF'
          #!/bin/bash
          echo "ðŸš€ Deploying Music Runner v${{ env.VERSION }}"
          docker load < docker/backend-${{ env.VERSION }}.tar.gz
          docker load < docker/client-${{ env.VERSION }}.tar.gz
          cd .. && docker-compose up -d
          echo "âœ… Deployment complete!"
          echo "ðŸŽ® Game: http://localhost:3000"
          echo "ðŸ“¡ API: http://localhost:3001/api/health"
          DEPLOY_EOF
          
          chmod +x music-runner-${{ env.VERSION }}/scripts/deploy.sh
          
          # Create release README
          cat > music-runner-${{ env.VERSION }}/README.md << 'README_EOF'
          # Music Runner - Release v${{ env.VERSION }}
          
          ## Deployment Artifact v${{ env.VERSION }}
          
          **Build Details:**
          - Version: ${{ env.VERSION }}
          - Build: #${{ github.run_number }}
          - Commit: ${{ github.sha }}
          - Date: ${{ env.BUILD_DATE }}
          - Tests Status: âœ… All passed
          
          ## Quick Deploy
          
          ```bash
          unzip music-runner-${{ env.VERSION }}.zip
          cd music-runner-${{ env.VERSION }}
          ./scripts/deploy.sh
          ```
          
          ## What's Included
          
          - âœ… Complete source code
          - âœ… Docker images (backend & frontend)
          - âœ… Project documentation (PDF)
          - âœ… Test coverage reports
          - âœ… Deployment scripts
          
          ## System Requirements
          
          - Docker 20.10+
          - Docker Compose 2.0+
          - 2GB RAM
          - 5GB disk space
          
          This artifact contains the complete website ready for deployment.
          README_EOF
          
          # Create ZIP
          zip -r music-runner-${{ env.VERSION }}.zip music-runner-${{ env.VERSION }}/
          
          echo ""
          echo "âœ… Release package created:"
          ls -lh music-runner-${{ env.VERSION }}.zip
          echo "=========================================="
      
      - name: ðŸ“ Generate Release Notes
        run: |
          cat > RELEASE_NOTES.md << 'NOTES_EOF'
          ## ðŸŽµ Music Runner v${{ env.VERSION }}
          
          ### Deployment Artifact v${{ env.VERSION }}
          
          **Build Details:**
          - Version: ${{ env.VERSION }}
          - Build #: ${{ github.run_number }}
          - Commit: `${{ github.sha }}`
          - Build time: ${{ env.BUILD_DATE }}
          - Tests Status: âœ… All passed
          
          ### This artifact contains the complete website ready for deployment.
          
          ---
          
          ## ðŸ“¦ Package Contents
          
          - âœ… Complete source code
          - âœ… Docker images (backend-${{ env.VERSION }}.tar.gz & client-${{ env.VERSION }}.tar.gz)
          - âœ… Project documentation (PDF with version history)
          - âœ… Test coverage reports
          - âœ… Deployment automation scripts
          
          ## ðŸš€ Quick Deploy
          
          ```bash
          # Download and extract
          unzip music-runner-${{ env.VERSION }}.zip
          cd music-runner-${{ env.VERSION }}
          
          # Deploy
          ./scripts/deploy.sh
          ```
          
          ## ðŸŽ® Access
          
          - **Game**: http://localhost:3000
          - **API**: http://localhost:3001/api/health
          
          ## ðŸ“‹ System Requirements
          
          - Docker 20.10+
          - Docker Compose 2.0+
          - 2GB RAM
          - 5GB disk space
          
          ## ðŸ“„ Assets
          
          - `music-runner-${{ env.VERSION }}.zip` - Complete deployment package
          - `Source code (zip)` - Source code only
          - `Source code (tar.gz)` - Source code only
          NOTES_EOF
      
      - name: ðŸ·ï¸ Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ env.VERSION }}
          name: Release ${{ env.VERSION }}
          body_path: RELEASE_NOTES.md
          draft: false
          prerelease: false
          files: |
            music-runner-${{ env.VERSION }}.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: ðŸŽ‰ Release Complete
        run: |
          echo "=========================================="
          echo "ðŸŽ‰ GITHUB RELEASE CREATED"
          echo "=========================================="
          echo "Version: v${{ env.VERSION }}"
          echo "Package: music-runner-${{ env.VERSION }}.zip"
          echo ""
          echo "View at:"
          echo "https://github.com/${{ github.repository }}/releases/tag/v${{ env.VERSION }}"
          echo "=========================================="

  # ============================================
  # JOB 5: PIPELINE SUMMARY
  # ============================================
  summary:
    name: ðŸ“‹ Pipeline Summary
    runs-on: ubuntu-latest
    needs: [compile-latex, build-and-test, package-docker, create-release]
    if: always()
    
    steps:
      - name: ðŸ“Š Display Pipeline Summary
        run: |
          echo "=========================================="
          echo "ðŸŽµ MUSIC RUNNER CI/CD PIPELINE"
          echo "   BUILD SUMMARY REPORT"
          echo "=========================================="
          echo ""
          echo "Version: v${{ env.VERSION }}"
          echo "Build: #${{ github.run_number }}"
          echo "Commit: ${{ github.sha }}"
          echo "Branch: ${{ github.ref_name }}"
          echo "Actor: ${{ github.actor }}"
          echo ""
          echo "Job Results:"
          echo "------------"
          echo "ðŸ“„ Documentation:     ${{ needs.compile-latex.result }}"
          echo "ðŸ—ï¸ Build & Test:      ${{ needs.build-and-test.result }}"
          echo "ðŸ³ Docker Package:    ${{ needs.package-docker.result }}"
          echo "ðŸ“¦ GitHub Release:    ${{ needs.create-release.result }}"
          echo ""
          echo "=========================================="
          if [ "${{ needs.build-and-test.result }}" == "success" ]; then
            echo "âœ… PIPELINE SUCCESSFUL"
            echo "ðŸ“¦ Release: v${{ env.VERSION }}"
            echo "ðŸŽ® Ready for deployment"
          else
            echo "âŒ PIPELINE FAILED"
            echo "âš ï¸  Check logs above"
          fi
          echo "=========================================="